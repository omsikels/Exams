<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Real Emotion Detection - ML Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header .admin-info {
            opacity: 0.8;
            font-size: 14px;
        }

        .model-status-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .model-status-real {
            background: #28a745;
            color: white;
        }

        .model-status-simulation {
            background: #ffc107;
            color: #212529;
        }

        .login-section {
            padding: 40px;
            text-align: center;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .main-content {
            display: none;
            padding: 20px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-info-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #2196f3;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .model-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .model-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .model-info-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .model-info-value {
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .emotions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .emotion-chip {
            background: #667eea;
            color: white;
            padding: 5px 8px;
            border-radius: 15px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-info:hover {
            background: #138496;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .status-success {
            color: #28a745;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        .emotion-tag {
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .confidence-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 3px;
        }

        .confidence-fill {
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .model-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .model-badge-real {
            background: #28a745;
            color: white;
        }

        .model-badge-simulation {
            background: #6c757d;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .log-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .face-detection-info {
            background: #e1f5fe;
            border: 1px solid #0288d1;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .actions {
                justify-content: center;
            }
            
            .results-table {
                font-size: 14px;
            }

            .emotions-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="model-status-badge" id="modelStatusBadge">Loading...</div>
            <h1>
                <span>ü§ñ</span>
                <span>Real Emotion Detection - ML Management</span>
            </h1>
            <div class="admin-info">
                <span id="adminInfo">Admin Only Access - Real NKF Model Integration</span>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>üîê Admin Authentication</h2>
            <p>Access the real emotion detection ML processing system</p>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="adminUsername">Username:</label>
                    <input type="text" id="adminUsername" value="admin" required>
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword" value="exam3000" required>
                </div>
                
                <button id="loginBtn" class="btn">üîë Login as Admin</button>
            </div>
            
            <div id="loginError" class="error" style="display: none;"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-content">
            <!-- Dashboard -->
            <div class="dashboard">
                <!-- Model Information Card -->
                <div class="card model-info-card">
                    <h3>üß† Emotion Detection Model</h3>
                    <div class="model-info">
                        <div class="model-info-item">
                            <span class="model-info-label">Model Type:</span>
                            <span class="model-info-value" id="modelType">Loading...</span>
                        </div>
                        <div class="model-info-item">
                            <span class="model-info-label">Backbone:</span>
                            <span class="model-info-value" id="modelBackbone">ResNet50</span>
                        </div>
                        <div class="model-info-item">
                            <span class="model-info-label">Device:</span>
                            <span class="model-info-value" id="modelDevice">Loading...</span>
                        </div>
                        <div class="model-info-item">
                            <span class="model-info-label">Face Detection:</span>
                            <span class="model-info-value" id="faceDetection">Haar + FAN</span>
                        </div>
                    </div>
                    <div class="model-info-label">Supported Emotions:</div>
                    <div class="emotions-grid" id="emotionsGrid">
                        <div class="emotion-chip">üò† Angry</div>
                        <div class="emotion-chip">ü§¢ Disgust</div>
                        <div class="emotion-chip">üò® Fear</div>
                        <div class="emotion-chip">üòä Happy</div>
                        <div class="emotion-chip">üò¢ Sad</div>
                        <div class="emotion-chip">üòÆ Surprise</div>
                        <div class="emotion-chip">üòê Neutral</div>
                    </div>
                </div>

                <!-- System Status Card -->
                <div class="card">
                    <h3>üìä System Statistics</h3>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalStudents">-</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalVideos">-</div>
                            <div class="stat-label">Total Videos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="processedVideos">-</div>
                            <div class="stat-label">Processed Videos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="storageUsed">-</div>
                            <div class="stat-label">Storage (MB)</div>
                        </div>
                    </div>
                </div>

                <!-- Processing Actions Card -->
                <div class="card">
                    <h3>üé¨ Processing Actions</h3>
                    <div class="actions">
                        <button id="refreshBtn" class="btn">üîÑ Refresh Status</button>
                        <button id="modelStatusBtn" class="btn btn-info">üß† Model Info</button>
                        <button id="batchProcessBtn" class="btn btn-success">‚ö° Batch Process</button>
                        <button id="viewResultsBtn" class="btn btn-warning">üìã View Results</button>
                        <button id="logoutBtn" class="btn btn-danger">üîì Logout</button>
                    </div>
                    <div class="face-detection-info">
                        <strong>üéØ Real Emotion Detection:</strong> 
                        Videos are processed using the trained NKF model with ResNet50 backbone 
                        and FAN landmarks for accurate emotion recognition.
                    </div>
                </div>
            </div>

            <!-- Student Videos Section -->
            <div class="card">
                <h3>üë• Student Videos</h3>
                <div id="studentsLoading" class="loading">Loading student data...</div>
                <div id="studentsContent" style="display: none;">
                    <div id="studentsTable"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="card">
                    <h3>üìà Processing Results</h3>
                    <div id="resultsLoading" class="loading">Loading results...</div>
                    <div id="resultsContent" style="display: none;">
                        <table id="resultsTable" class="results-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Video</th>
                                    <th>Status</th>
                                    <th>Primary Emotion</th>
                                    <th>Confidence</th>
                                    <th>Model</th>
                                    <th>Processed At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Processing Log -->
            <div id="processingLog" class="card" style="display: none;">
                <h3>üìù Processing Log</h3>
                <div id="logOutput" class="log-output"></div>
            </div>
        </div>
    </div>

    <script>
        class RealEmotionMLManager {
            constructor() {
                this.baseURL = 'http://localhost:5000';
                this.isAuthenticated = false;
                this.adminUser = null;
                this.modelInfo = null;
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('refreshBtn').addEventListener('click', () => this.refreshStatus());
                document.getElementById('modelStatusBtn').addEventListener('click', () => this.showModelStatus());
                document.getElementById('batchProcessBtn').addEventListener('click', () => this.batchProcess());
                document.getElementById('viewResultsBtn').addEventListener('click', () => this.viewResults());

                // Enter key for login
                document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
            }

            async login() {
                const username = document.getElementById('adminUsername').value;
                const password = document.getElementById('adminPassword').value;
                const loginBtn = document.getElementById('loginBtn');
                const errorDiv = document.getElementById('loginError');

                loginBtn.disabled = true;
                loginBtn.textContent = 'üîë Authenticating...';
                errorDiv.style.display = 'none';

                try {
                    const response = await fetch(`${this.baseURL}/admin/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.isAuthenticated = true;
                        this.adminUser = username;
                        this.showMainContent();
                        await this.loadModelInfo();
                        this.refreshStatus();
                        this.loadStudents();
                    } else {
                        this.showError(errorDiv, data.message || 'Authentication failed');
                    }
                } catch (error) {
                    this.showError(errorDiv, `Connection error: ${error.message}`);
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'üîë Login as Admin';
                }
            }

            async logout() {
                try {
                    await fetch(`${this.baseURL}/admin/logout`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                } catch (error) {
                    console.warn('Logout request failed:', error);
                }

                this.isAuthenticated = false;
                this.adminUser = null;
                this.showLoginForm();
            }

            showMainContent() {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('adminInfo').textContent = `Admin: ${this.adminUser} | Real Emotion Detection Active`;
            }

            showLoginForm() {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('adminInfo').textContent = 'Admin Only Access - Real NKF Model Integration';
                document.getElementById('adminPassword').value = '';
            }

            async loadModelInfo() {
                try {
                    const response = await fetch(`${this.baseURL}/admin/model-status`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.modelInfo = data.model_info;
                        this.updateModelDisplay();
                    }
                } catch (error) {
                    console.error('Failed to load model info:', error);
                }
            }

            updateModelDisplay() {
                if (!this.modelInfo) return;

                const badge = document.getElementById('modelStatusBadge');
                const modelType = document.getElementById('modelType');
                const modelDevice = document.getElementById('modelDevice');

                if (this.modelInfo.real_model_available) {
                    badge.textContent = '‚úÖ Real Model';
                    badge.className = 'model-status-badge model-status-real';
                    modelType.textContent = this.modelInfo.model_type;
                } else {
                    badge.textContent = '‚ö†Ô∏è Simulation';
                    badge.className = 'model-status-badge model-status-simulation';
                    modelType.textContent = 'Simulation Mode';
                }

                modelDevice.textContent = this.modelInfo.device || 'Unknown';
            }

            async refreshStatus() {
                try {
                    const response = await fetch(`${this.baseURL}/admin/system-status`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.updateStatusDisplay(data);
                    } else {
                        console.error('Failed to refresh status');
                    }
                } catch (error) {
                    console.error('Status refresh error:', error);
                }
            }

            updateStatusDisplay(data) {
                const stats = data.statistics || {};
                const storage = data.storage || {};

                document.getElementById('totalStudents').textContent = stats.total_students || 0;
                document.getElementById('totalVideos').textContent = stats.total_videos || 0;
                document.getElementById('processedVideos').textContent = stats.processed_videos || 0;
                document.getElementById('storageUsed').textContent = 
                    ((storage.video_directory_mb || 0) + (storage.output_directory_mb || 0)).toFixed(1);

                // Update model status
                if (data.model_status) {
                    const badge = document.getElementById('modelStatusBadge');
                    if (data.model_status.real_model_loaded) {
                        badge.textContent = '‚úÖ Real Model';
                        badge.className = 'model-status-badge model-status-real';
                    } else {
                        badge.textContent = '‚ö†Ô∏è Simulation';
                        badge.className = 'model-status-badge model-status-simulation';
                    }
                }
            }

            async showModelStatus() {
                if (!this.modelInfo) {
                    await this.loadModelInfo();
                }

                let statusText = "üß† EMOTION DETECTION MODEL STATUS\n\n";
                if (this.modelInfo) {
                    statusText += `Model Type: ${this.modelInfo.model_type}\n`;
                    statusText += `Real Model Available: ${this.modelInfo.real_model_available ? 'YES' : 'NO'}\n`;
                    statusText += `Device: ${this.modelInfo.device}\n`;
                    statusText += `Face Detection: ${this.modelInfo.face_detection ? 'Enabled' : 'Disabled'}\n\n`;
                    statusText += `Supported Emotions:\n`;
                    this.modelInfo.emotions_supported?.forEach((emotion, index) => {
                        statusText += `${index}: ${emotion}\n`;
                    });
                    
                    if (this.modelInfo.model_path) {
                        statusText += `\nModel Path: ${this.modelInfo.model_path}`;
                    }
                } else {
                    statusText += "Model information not available";
                }

                alert(statusText);
            }

            async loadStudents() {
                const loadingDiv = document.getElementById('studentsLoading');
                const contentDiv = document.getElementById('studentsContent');
                const tableDiv = document.getElementById('studentsTable');

                loadingDiv.style.display = 'block';
                contentDiv.style.display = 'none';

                try {
                    const response = await fetch(`${this.baseURL}/admin/students`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.displayStudents(data.students || {});
                        contentDiv.style.display = 'block';
                    } else {
                        tableDiv.innerHTML = '<p class="error">Failed to load student data</p>';
                        contentDiv.style.display = 'block';
                    }
                } catch (error) {
                    tableDiv.innerHTML = `<p class="error">Connection error: ${error.message}</p>`;
                    contentDiv.style.display = 'block';
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            displayStudents(students) {
                const tableDiv = document.getElementById('studentsTable');
                
                if (Object.keys(students).length === 0) {
                    tableDiv.innerHTML = '<p>No student videos found.</p>';
                    return;
                }

                let html = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Video Count</th>
                                <th>Recent Videos</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const [studentName, studentData] of Object.entries(students)) {
                    const recentVideos = studentData.videos.slice(0, 3).map(v => v.filename).join(', ');
                    html += `
                        <tr>
                            <td><strong>${studentName}</strong></td>
                            <td>${studentData.video_count}</td>
                            <td title="${studentData.videos.map(v => v.filename).join(', ')}">${recentVideos}${studentData.video_count > 3 ? '...' : ''}</td>
                            <td>
                                <button class="btn" onclick="realEmotionML.processStudent('${studentName}')">ü§ñ Process with Real Model</button>
                            </td>
                        </tr>
                    `;
                }

                html += '</tbody></table>';
                tableDiv.innerHTML = html;
            }

            async batchProcess() {
                const btn = document.getElementById('batchProcessBtn');
                const originalText = btn.textContent;
                
                btn.disabled = true;
                btn.textContent = '‚ö° Processing with Real Model...';
                
                this.showProcessingLog();
                this.addLog('ü§ñ Starting batch processing with real emotion detection...');

                try {
                    const response = await fetch(`${this.baseURL}/admin/batch-process`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({}),
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.addLog(`‚úÖ Batch processing completed successfully!`);
                        this.addLog(`üë• Students: ${data.summary.total_students}`);
                        this.addLog(`üé¨ Videos processed: ${data.summary.total_videos_processed}`);
                        this.addLog(`üß† Model used: ${data.real_model_used ? 'Real NKF Model' : 'Simulation'}`);
                        this.refreshStatus();
                    } else {
                        this.addLog(`‚ùå Batch processing failed: ${data.message}`);
                    }
                } catch (error) {
                    this.addLog(`‚ùå Batch processing error: ${error.message}`);
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }

            async processStudent(studentName) {
                this.showProcessingLog();
                this.addLog(`ü§ñ Starting real emotion detection for student: ${studentName}`);

                try {
                    const response = await fetch(`${this.baseURL}/admin/batch-process`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ student_name: studentName }),
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.addLog(`‚úÖ Processing completed for ${studentName}`);
                        this.addLog(`üé¨ Videos processed: ${data.summary.results[studentName]?.processed_count || 0}`);
                        this.addLog(`üß† Model: ${data.real_model_used ? 'Real NKF Model' : 'Simulation'}`);
                        this.refreshStatus();
                    } else {
                        this.addLog(`‚ùå Processing failed for ${studentName}: ${data.message}`);
                    }
                } catch (error) {
                    this.addLog(`‚ùå Processing error for ${studentName}: ${error.message}`);
                }
            }

            async viewResults() {
                const section = document.getElementById('resultsSection');
                const loadingDiv = document.getElementById('resultsLoading');
                const contentDiv = document.getElementById('resultsContent');
                const tableBody = document.getElementById('resultsTableBody');

                section.style.display = 'block';
                loadingDiv.style.display = 'block';
                contentDiv.style.display = 'none';

                try {
                    const response = await fetch(`${this.baseURL}/admin/results`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.displayResults(data.results || []);
                        contentDiv.style.display = 'block';
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" class="error">Failed to load results</td></tr>';
                        contentDiv.style.display = 'block';
                    }
                } catch (error) {
                    tableBody.innerHTML = `<tr><td colspan="8" class="error">Connection error: ${error.message}</td></tr>`;
                    contentDiv.style.display = 'block';
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            displayResults(results) {
                const tableBody = document.getElementById('resultsTableBody');
                
                if (results.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8">No processing results found.</td></tr>';
                    return;
                }

                let html = '';
                results.forEach(result => {
                    const statusClass = result.status === 'success' ? 'status-success' : 'status-error';
                    const processedTime = new Date(result.processed_at).toLocaleString();
                    const confidence = result.confidence || 0;
                    const faceDetectionRate = result.face_detection_rate || 0;
                    
                    const modelBadge = result.real_model_used ? 
                        '<span class="model-badge model-badge-real">Real</span>' : 
                        '<span class="model-badge model-badge-simulation">Sim</span>';
                    
                    html += `
                        <tr>
                            <td><strong>${result.student}</strong></td>
                            <td>${result.video_name}</td>
                            <td class="${statusClass}">${result.status}</td>
                            <td>
                                ${result.primary_emotion ? `<span class="emotion-tag">${result.primary_emotion}</span>` : '-'}
                            </td>
                            <td>
                                ${confidence > 0 ? `
                                    ${(confidence * 100).toFixed(1)}%
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                                    </div>
                                ` : '-'}
                            </td>
                            <td>${modelBadge}</td>
                            <td>${processedTime}</td>
                            <td>
                                <button class="btn" onclick="realEmotionML.viewResultDetail('${result.filename}')">üëÅÔ∏è View</button>
                            </td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = html;
            }

            async viewResultDetail(filename) {
                try {
                    const response = await fetch(`${this.baseURL}/admin/result/${filename}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.showResultDetail(data.result);
                    } else {
                        alert('Failed to load result details');
                    }
                } catch (error) {
                    alert(`Error loading result: ${error.message}`);
                }
            }

            showResultDetail(result) {
                const emotions = result.emotions_detected || {};
                const segments = emotions.segments || [];
                const modelInfo = emotions.model_info || {};
                
                let detail = `ü§ñ REAL EMOTION DETECTION RESULT\n\n`;
                detail += `üìπ Video: ${result.video_info?.filename || 'Unknown'}\n`;
                detail += `üë§ Student: ${emotions.student || 'Unknown'}\n`;
                detail += `üòÄ Primary Emotion: ${emotions.primary_emotion || 'Unknown'}\n`;
                detail += `üìä Segments: ${emotions.summary?.total_segments || 0}\n`;
                detail += `üéØ Average Confidence: ${emotions.summary?.average_confidence || 0}\n`;
                detail += `üëÅÔ∏è Face Detection Rate: ${((emotions.summary?.face_detection_rate || 0) * 100).toFixed(1)}%\n`;
                detail += `üß† Real Model Used: ${emotions.real_model_used ? 'YES' : 'NO'}\n\n`;

                if (modelInfo.model_type) {
                    detail += `üî¨ MODEL INFORMATION:\n`;
                    detail += `Type: ${modelInfo.model_type}\n`;
                    detail += `Device: ${modelInfo.device}\n`;
                    detail += `Backbone: ${modelInfo.backbone}\n\n`;
                }
                
                if (segments.length > 0) {
                    detail += `üìà EMOTION SEGMENTS:\n`;
                    segments.forEach((s, index) => {
                        detail += `${index + 1}. ${s.start_time}s-${s.end_time}s: ${s.emotion} (${(s.confidence * 100).toFixed(1)}%)\n`;
                    });
                    detail += `\n`;
                }
                
                detail += `‚è∞ Processed: ${result.timestamp}\n`;
                detail += `üë®‚Äçüíª Admin User: ${result.admin_processed ? 'Yes' : 'No'}`;

                alert(detail);
            }

            showProcessingLog() {
                const logDiv = document.getElementById('processingLog');
                logDiv.style.display = 'block';
                document.getElementById('logOutput').innerHTML = '';
            }

            addLog(message) {
                const logOutput = document.getElementById('logOutput');
                const timestamp = new Date().toLocaleTimeString();
                logOutput.innerHTML += `[${timestamp}] ${message}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;
            }

            showError(element, message) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize the real emotion ML manager
        const realEmotionML = new RealEmotionMLManager();
    </script>
</body>
</html>