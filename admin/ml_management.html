<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Processing Management - Admin Only</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
        }

        .header .admin-info {
            opacity: 0.8;
            font-size: 14px;
        }

        .login-section {
            padding: 40px;
            text-align: center;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .main-content {
            display: none;
            padding: 20px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .status-success {
            color: #28a745;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        .emotion-tag {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .log-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .actions {
                justify-content: center;
            }
            
            .results-table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ ML Processing Management</h1>
            <div class="admin-info">
                <span id="adminInfo">Admin Only Access - Authentication Required</span>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>Admin Authentication</h2>
            <p>Please login to access the ML processing management system.</p>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="adminUsername">Username:</label>
                    <input type="text" id="adminUsername" value="admin" required>
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword" value="exam3000" required>
                </div>
                
                <button id="loginBtn" class="btn">üîê Login as Admin</button>
            </div>
            
            <div id="loginError" class="error" style="display: none;"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-content">
            <!-- Dashboard -->
            <div class="dashboard">
                <!-- System Status Card -->
                <div class="card">
                    <h3>üìä System Status</h3>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalStudents">-</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalVideos">-</div>
                            <div class="stat-label">Total Videos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="processedVideos">-</div>
                            <div class="stat-label">Processed Videos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="storageUsed">-</div>
                            <div class="stat-label">Storage Used (MB)</div>
                        </div>
                    </div>
                </div>

                <!-- Processing Actions Card -->
                <div class="card">
                    <h3>üé¨ Processing Actions</h3>
                    <div class="actions">
                        <button id="refreshBtn" class="btn">üîÑ Refresh Status</button>
                        <button id="batchProcessBtn" class="btn btn-success">‚ö° Batch Process All</button>
                        <button id="viewResultsBtn" class="btn btn-warning">üìã View Results</button>
                        <button id="logoutBtn" class="btn btn-danger">üîì Logout</button>
                    </div>
                </div>
            </div>

            <!-- Student Videos Section -->
            <div class="card">
                <h3>üë• Student Videos</h3>
                <div id="studentsLoading" class="loading">Loading student data...</div>
                <div id="studentsContent" style="display: none;">
                    <div id="studentsTable"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="card">
                    <h3>üìà Processing Results</h3>
                    <div id="resultsLoading" class="loading">Loading results...</div>
                    <div id="resultsContent" style="display: none;">
                        <table id="resultsTable" class="results-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Video</th>
                                    <th>Status</th>
                                    <th>Primary Emotion</th>
                                    <th>Processed At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Processing Log -->
            <div id="processingLog" class="card" style="display: none;">
                <h3>üìù Processing Log</h3>
                <div id="logOutput" class="log-output"></div>
            </div>
        </div>
    </div>

    <script>
        class AdminMLManager {
            constructor() {
                this.baseURL = 'http://localhost:5000';
                this.isAuthenticated = false;
                this.adminUser = null;
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('refreshBtn').addEventListener('click', () => this.refreshStatus());
                document.getElementById('batchProcessBtn').addEventListener('click', () => this.batchProcess());
                document.getElementById('viewResultsBtn').addEventListener('click', () => this.viewResults());

                // Enter key for login
                document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
            }

            async login() {
                const username = document.getElementById('adminUsername').value;
                const password = document.getElementById('adminPassword').value;
                const loginBtn = document.getElementById('loginBtn');
                const errorDiv = document.getElementById('loginError');

                loginBtn.disabled = true;
                loginBtn.textContent = 'üîê Authenticating...';
                errorDiv.style.display = 'none';

                try {
                    const response = await fetch(`${this.baseURL}/admin/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.isAuthenticated = true;
                        this.adminUser = username;
                        this.showMainContent();
                        this.refreshStatus();
                        this.loadStudents();
                    } else {
                        this.showError(errorDiv, data.message || 'Authentication failed');
                    }
                } catch (error) {
                    this.showError(errorDiv, `Connection error: ${error.message}`);
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'üîê Login as Admin';
                }
            }

            async logout() {
                try {
                    await fetch(`${this.baseURL}/admin/logout`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                } catch (error) {
                    console.warn('Logout request failed:', error);
                }

                this.isAuthenticated = false;
                this.adminUser = null;
                this.showLoginForm();
            }

            showMainContent() {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('adminInfo').textContent = `Admin: ${this.adminUser} | ML Processing Management`;
            }

            showLoginForm() {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('adminInfo').textContent = 'Admin Only Access - Authentication Required';
                document.getElementById('adminPassword').value = '';
            }

            async refreshStatus() {
                try {
                    const response = await fetch(`${this.baseURL}/admin/system-status`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.updateStatusDisplay(data);
                    } else {
                        console.error('Failed to refresh status');
                    }
                } catch (error) {
                    console.error('Status refresh error:', error);
                }
            }

            updateStatusDisplay(data) {
                const stats = data.statistics || {};
                const storage = data.storage || {};

                document.getElementById('totalStudents').textContent = stats.total_students || 0;
                document.getElementById('totalVideos').textContent = stats.total_videos || 0;
                document.getElementById('processedVideos').textContent = stats.processed_videos || 0;
                document.getElementById('storageUsed').textContent = 
                    ((storage.video_directory_mb || 0) + (storage.output_directory_mb || 0)).toFixed(1);
            }

            async loadStudents() {
                const loadingDiv = document.getElementById('studentsLoading');
                const contentDiv = document.getElementById('studentsContent');
                const tableDiv = document.getElementById('studentsTable');

                loadingDiv.style.display = 'block';
                contentDiv.style.display = 'none';

                try {
                    const response = await fetch(`${this.baseURL}/admin/students`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.displayStudents(data.students || {});
                        contentDiv.style.display = 'block';
                    } else {
                        tableDiv.innerHTML = '<p class="error">Failed to load student data</p>';
                        contentDiv.style.display = 'block';
                    }
                } catch (error) {
                    tableDiv.innerHTML = `<p class="error">Connection error: ${error.message}</p>`;
                    contentDiv.style.display = 'block';
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            displayStudents(students) {
                const tableDiv = document.getElementById('studentsTable');
                
                if (Object.keys(students).length === 0) {
                    tableDiv.innerHTML = '<p>No student videos found.</p>';
                    return;
                }

                let html = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Video Count</th>
                                <th>Recent Videos</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const [studentName, studentData] of Object.entries(students)) {
                    const recentVideos = studentData.videos.slice(0, 3).map(v => v.filename).join(', ');
                    html += `
                        <tr>
                            <td><strong>${studentName}</strong></td>
                            <td>${studentData.video_count}</td>
                            <td title="${studentData.videos.map(v => v.filename).join(', ')}">${recentVideos}${studentData.video_count > 3 ? '...' : ''}</td>
                            <td>
                                <button class="btn" onclick="adminML.processStudent('${studentName}')">üé¨ Process</button>
                            </td>
                        </tr>
                    `;
                }

                html += '</tbody></table>';
                tableDiv.innerHTML = html;
            }

            async batchProcess() {
                const btn = document.getElementById('batchProcessBtn');
                const originalText = btn.textContent;
                
                btn.disabled = true;
                btn.textContent = '‚ö° Processing...';
                
                this.showProcessingLog();
                this.addLog('Starting batch processing for all students...');

                try {
                    const response = await fetch(`${this.baseURL}/admin/batch-process`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({}),
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.addLog(`‚úÖ Batch processing completed successfully!`);
                        this.addLog(`üìä Students: ${data.summary.total_students}`);
                        this.addLog(`üìπ Videos processed: ${data.summary.total_videos_processed}`);
                        this.refreshStatus();
                    } else {
                        this.addLog(`‚ùå Batch processing failed: ${data.message}`);
                    }
                } catch (error) {
                    this.addLog(`‚ùå Batch processing error: ${error.message}`);
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }

            async processStudent(studentName) {
                this.showProcessingLog();
                this.addLog(`Starting processing for student: ${studentName}`);

                try {
                    const response = await fetch(`${this.baseURL}/admin/batch-process`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ student_name: studentName }),
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.addLog(`‚úÖ Processing completed for ${studentName}`);
                        this.addLog(`üìπ Videos processed: ${data.summary.results[studentName]?.processed_count || 0}`);
                        this.refreshStatus();
                    } else {
                        this.addLog(`‚ùå Processing failed for ${studentName}: ${data.message}`);
                    }
                } catch (error) {
                    this.addLog(`‚ùå Processing error for ${studentName}: ${error.message}`);
                }
            }

            async viewResults() {
                const section = document.getElementById('resultsSection');
                const loadingDiv = document.getElementById('resultsLoading');
                const contentDiv = document.getElementById('resultsContent');
                const tableBody = document.getElementById('resultsTableBody');

                section.style.display = 'block';
                loadingDiv.style.display = 'block';
                contentDiv.style.display = 'none';

                try {
                    const response = await fetch(`${this.baseURL}/admin/results`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.displayResults(data.results || []);
                        contentDiv.style.display = 'block';
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" class="error">Failed to load results</td></tr>';
                        contentDiv.style.display = 'block';
                    }
                } catch (error) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="error">Connection error: ${error.message}</td></tr>`;
                    contentDiv.style.display = 'block';
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            displayResults(results) {
                const tableBody = document.getElementById('resultsTableBody');
                
                if (results.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">No processing results found.</td></tr>';
                    return;
                }

                let html = '';
                results.forEach(result => {
                    const statusClass = result.status === 'success' ? 'status-success' : 'status-error';
                    const processedTime = new Date(result.processed_at).toLocaleString();
                    
                    html += `
                        <tr>
                            <td><strong>${result.student}</strong></td>
                            <td>${result.video_name}</td>
                            <td class="${statusClass}">${result.status}</td>
                            <td>
                                ${result.primary_emotion ? `<span class="emotion-tag">${result.primary_emotion}</span>` : '-'}
                            </td>
                            <td>${processedTime}</td>
                            <td>
                                <button class="btn" onclick="adminML.viewResultDetail('${result.filename}')">üëÅÔ∏è View</button>
                            </td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = html;
            }

            async viewResultDetail(filename) {
                try {
                    const response = await fetch(`${this.baseURL}/admin/result/${filename}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.showResultDetail(data.result);
                    } else {
                        alert('Failed to load result details');
                    }
                } catch (error) {
                    alert(`Error loading result: ${error.message}`);
                }
            }

            showResultDetail(result) {
                const emotions = result.emotions_detected || {};
                const segments = emotions.segments || [];
                
                let segmentInfo = segments.map(s => 
                    `${s.start_time}s-${s.end_time}s: ${s.emotion} (${s.confidence})`
                ).join('\n');

                const detail = `
                Video: ${result.video_info?.filename || 'Unknown'}
                Student: ${emotions.student || 'Unknown'}
                Primary Emotion: ${emotions.primary_emotion || 'Unknown'}
                Segments: ${emotions.summary?.total_segments || 0}
                Average Confidence: ${emotions.summary?.average_confidence || 0}
                
                Segment Details:
                ${segmentInfo}
                
                Processed: ${result.timestamp}
                Admin User: ${result.admin_processed ? 'Yes' : 'No'}
                `;

                alert(detail);
            }

            showProcessingLog() {
                const logDiv = document.getElementById('processingLog');
                logDiv.style.display = 'block';
                document.getElementById('logOutput').innerHTML = '';
            }

            addLog(message) {
                const logOutput = document.getElementById('logOutput');
                const timestamp = new Date().toLocaleTimeString();
                logOutput.innerHTML += `[${timestamp}] ${message}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;
            }

            showError(element, message) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize the admin ML manager
        const adminML = new AdminMLManager();
    </script>
</body>
</html>